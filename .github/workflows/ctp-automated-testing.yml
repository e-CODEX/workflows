name: Main CI Workflow 

on:
  workflow_call:
    inputs:
      branch:
        description: 'Branch name'
        required: false
        type: string
      node_version:
        description: 'Node.js version'
        required: false
        default: '16'
        type: string
      java_version:
        description: 'Java version'
        required: false
        default: "21"
        type: string
      maven-parameters:
        description: 'Extra parameters to pass to Maven'
        required: false
        type: string  
        default: "-DskipTests"
    #  docker_image:
    #    description: 'Name of the docker image to build and push'
    #    required: false
    #    type: string
    #    default: ''
      run_test:
        description: 'Run test stage'
        required: false
        default: false
        type: boolean
      run_sonarcloud:
        description: 'Run SonarCloud analysis'
        required: false
        default: false
        type: boolean
      run_codeql:
        description: 'Run CodeQL analysis'
        required: false
        default: false
        type: boolean
      run_qodana:
        description: 'Run Qodana analysis'
        required: false
        default: false
        type: boolean
      run_docker:
        description: 'Build and push Docker image'
        required: false
        default: false
        type: boolean
      run_maven_publish:
        description: 'Publish Maven release'
        required: false
        default: false
        type: boolean


jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug info
        run: |
          echo "Branch: ${{ inputs.branch }}"
          echo "Node.js Version: ${{ inputs.node_version }}"
          echo "Java Version: ${{ inputs.java_version }}"
          echo "Run Tests: ${{ inputs.run_test }}"
          echo "Run SonarCloud: ${{ inputs.run_sonarcloud }}"
          echo "Run CodeQL: ${{ inputs.run_codeql }}"
          echo "Run Qodana: ${{ inputs.run_qodana }}"
          echo "Run Docker: ${{ inputs.run_docker }}"
          echo "Run Maven Publish: ${{ inputs.run_maven_publish }}"

  load-config:
    uses: ./.github/workflows/load-config.yaml
    with:
      config-path: ci-properties.json
    secrets: inherit

  mvn-npm-check:
    uses: ./.github/workflows/verify-mvn-npm.yml
    secrets: inherit

  build:    #here either we only build or we build and run Codeql 
    needs: mvn-npm-check
    uses: ./.github/workflows/ci-build.yaml
    with:
      is_npm: ${{ needs.mvn-npm-check.outputs.project_type == 'npm' }}
      is_mvn: ${{ needs.mvn-npm-check.outputs.project_type == 'maven' || needs.mvn-npm-check.outputs.project_type == 'both' }}
      java-version: ${{ inputs.java_version }}
      node-version: ${{ inputs.node_version }}
      codeql: ${{fromJSON(inputs.run_codeql || 'false')}}
      maven-parameters: ${{ inputs.maven-parameters }}
    secrets: inherit

  test:
    if: ${{ inputs.run_test == true }}
    uses: ./.github/workflows/ci-tests.yaml
    needs: mvn-npm-check
    with:
      is_npm: ${{ needs.mvn-npm-check.outputs.project_type == 'npm'  }}
      is_mvn: ${{ needs.mvn-npm-check.outputs.project_type == 'maven' || needs.mvn-npm-check.outputs.project_type == 'both' }}
      java-version: ${{ inputs.java_version }}
      node-version: ${{ inputs.node_version }}
      branch: ${{ inputs.branch }}
    secrets: inherit

  sonarcloud:
    if: ${{ inputs.run_sonarcloud == true }}
    needs: [test, mvn-npm-check]
    uses: ./.github/workflows/sonar-java.yaml
    with:
      java-version: ${{ inputs.java_version }}
      node-version: ${{ inputs.node_version }}
      build-tool: ${{ needs.mvn-npm-check.outputs.project_type  }}
    secrets: inherit


  qodana:
    if: ${{ inputs.run_qodana == true }}
    needs: test
    uses: ./.github/workflows/qodana.yaml
    secrets: inherit

  maven-validate-release-version:
    if: ${{ inputs.run_maven_publish == true }}
    needs: test
    uses: ./.github/workflows/maven-validate-release-version.yaml

  docker-build-push:
    if: ${{ inputs.run_docker == 'true' }} 
    needs: [test, load-config]
    uses: ./.github/workflows/docker-build-push.yaml
    with:
      image-name: ${{ fromJson(needs.load-config.outputs.dockerImage) }}
      tag: ${{ github.sha }}
      environment: development
      registry: your-registry-url

  maven-publish-snapshot:
    if: ${{ inputs.run_maven_publish == 'true' }}
    needs: test
    uses: ./.github/workflows/maven-publish-snapshot.yaml
    with:
      java-version: 21
      maven-repo-id: your-snapshot-repo-id
      maven-parameters: "-DskipTests"

  maven-tag-release-version:
    if: ${{ inputs.run_maven_publish == 'true' }}
    needs: maven-validate-release-version
    uses: ./.github/workflows/maven-tag-release-version.yaml
    with:
      environment: other

  maven-publish-release:
    if: ${{ inputs.run_maven_publish == 'true' }}
    needs: [maven-validate-release-version, maven-tag-release-version]
    uses: ./.github/workflows/maven-publish-release.yaml
    with:
      java-version: 21
      maven-repo-id: your-maven-repo-id
      maven-parameters: "-DskipTests"
      environment: other