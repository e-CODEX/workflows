name: CTP Automated Testing

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number'
        required: true
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: string
      node_version:
        description: 'Node.js version'
        required: true
        default: '16'
      java_version:
        description: 'Java version'
        required: true
        default: '21'
        type: string
    #  docker_image:
    #    description: 'Name of the docker image to build and push'
    #    required: false
    #    type: string
    #    default: ''
      run_test:
        description: 'Run test stage'
        required: false
        default: false
        type: boolean
      run_sonarcloud:
        description: 'Run SonarCloud analysis'
        required: false
        default: false
        type: boolean
      run_codeql:
        description: 'Run CodeQL analysis'
        required: false
        default: false
        type: boolean
      run_qodana:
        description: 'Run Qodana analysis'
        required: false
        default: false
        type: boolean
      run_docker:
        description: 'Build and push Docker image'
        required: false
        default: false
        type: boolean
      run_maven_publish:
        description: 'Publish Maven release'
        required: false
        default: false
        type: boolean


jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug info
        run: |
          echo "PR Number: ${{ github.event.inputs.pr_number }}"
          echo "Branch: ${{ github.event.inputs.branch }}"
          echo "Node.js Version: ${{ github.event.inputs.node_version }}"
          echo "Java Version: ${{ github.event.inputs.java_version }}"
          echo "Run Tests: ${{ github.event.inputs.run_test }}"
          echo "Run SonarCloud: ${{ github.event.inputs.run_sonarcloud }}"
          echo "Run CodeQL: ${{ github.event.inputs.run_codeql }}"
          echo "Run Qodana: ${{ github.event.inputs.run_qodana }}"
          echo "Run Docker: ${{ github.event.inputs.run_docker }}"
          echo "Run Maven Publish: ${{ github.event.inputs.run_maven_publish }}"
  mvn-npm-check:
    uses: ./.github/workflows/verify-mvn-npm.yml
    with:
      branch: ${{ github.event.inputs.branch }}
    secrets: inherit

  build:    #here either we only build or we build and run Codeql 
    needs: mvn-npm-check
    uses: ./.github/workflows/ci-build.yaml
    with:
      is_npm: ${{ needs.mvn-npm-check.outputs.project_type == 'npm' }}
      is_mvn: ${{ needs.mvn-npm-check.outputs.project_type == 'maven' || needs.mvn-npm-check.outputs.project_type == 'both' }}
      java-version: ${{ github.event.inputs.java_version }}
      node-version: ${{ github.event.inputs.node_version }}
      codeql: true
      maven-parameters: "-DskipTests"
      sbom-path: dist/sbom.json
      artifact-path: dist/
      branch: ${{ github.event.inputs.branch }}
    secrets: inherit

  test:
    if: ${{ github.event.inputs.run_test == 'true' }}
    uses: ./.github/workflows/ci-tests.yaml
    needs: mvn-npm-check
    with:
      is_npm: ${{ needs.mvn-npm-check.outputs.project_type == 'npm'  }}
      is_mvn: ${{ needs.mvn-npm-check.outputs.project_type == 'maven' || needs.mvn-npm-check.outputs.project_type == 'both' }}
      java-version: ${{ github.event.inputs.java_version }}
      node-version: ${{ github.event.inputs.node_version }}
      branch: ${{ github.event.inputs.branch }}

  sonarcloud:
    if: ${{ github.event.inputs.run_sonarcloud == 'true' }}
    needs: test
    uses: e-CODEX/workflows/.github/workflows/sonar-java.yaml@main
    with:
      java-version: 21
      build-tool: 'maven'
    secrets: inherit



  qodana:
    if: ${{ github.event.inputs.run_qodana == 'true' }}
    needs: test
    uses: e-CODEX/workflows/.github/workflows/qodana.yaml@main
    secrets: inherit

  maven-validate-release-version:
    if: ${{ github.event.inputs.run_maven_publish == 'true' }}
    needs: test
    uses: ./.github/workflows/maven-validate-release-version.yaml

  docker-build-push:
    if: ${{ github.event.inputs.run_docker == 'true' && github.event.inputs.docker_image != '' }} 
    needs: test
    uses: ./.github/workflows/docker-build-push.yaml
    with:
      image-name: ${{ github.event.inputs.docker_image }}
      tag: ${{ github.sha }}
      environment: development
      registry: your-registry-url

  maven-publish-snapshot:
    if: ${{ github.event.inputs.run_maven_publish == 'true' }}
    needs: test
    uses: ./.github/workflows/maven-publish-snapshot.yaml
    with:
      java-version: 21
      maven-repo-id: your-snapshot-repo-id
      maven-parameters: "-DskipTests"

  maven-tag-release-version:
    if: ${{ github.event.inputs.run_maven_publish == 'true' }}
    needs: maven-validate-release-version
    uses: ./.github/workflows/maven-tag-release-version.yaml
    with:
      environment: other

  maven-publish-release:
    if: ${{ github.event.inputs.run_maven_publish == 'true' }}
    needs: [maven-validate-release-version, maven-tag-release-version]
    uses: ./.github/workflows/maven-publish-release.yaml
    with:
      java-version: 21
      maven-repo-id: your-maven-repo-id
      maven-parameters: "-DskipTests"
      environment: other