name: Load CI config

on:
  workflow_call:
    inputs:
      config-path:
        description: "Path to JSON config in the caller repo"
        required: false
        type: string
        default: "./.github/ci-properties.json"
    outputs:
      maven_sbom_path:
        description: "Maven SBOM path"
        value: ${{ jobs.parse.outputs.maven_sbom_path }}
      maven_artifact_path:
        description: "Maven artifact path"
        value: ${{ jobs.parse.outputs.maven_artifact_path }}
      maven_parameters:
        description: "Extra Maven parameters"
        value: ${{ jobs.parse.outputs.maven_parameters }}
      npm_sbom_path:
        description: "NPM SBOM path"
        value: ${{ jobs.parse.outputs.npm_sbom_path }}
      npm_artifact_path:
        description: "NPM artifact path"
        value: ${{ jobs.parse.outputs.npm_artifact_path }}
      jacoco_xml_report_path:
        description: "JaCoCo XML report path"
        value: ${{ jobs.parse.outputs.jacoco_xml_report_path }}
      dockerImage:
        description: "Docker image for testing and deployment"
        value: ${{ jobs.parse.outputs.dockerImage }}

jobs:
  parse:
    runs-on: ubuntu-latest
    outputs:
      maven_sbom_path:        ${{ steps.cfg.outputs.maven_sbom_path }}
      maven_artifact_path:    ${{ steps.cfg.outputs.maven_artifact_path }}
      maven_parameters:       ${{ steps.cfg.outputs.maven_parameters }}
      npm_sbom_path:          ${{ steps.cfg.outputs.npm_sbom_path }}
      npm_artifact_path:      ${{ steps.cfg.outputs.npm_artifact_path }}
      jacoco_xml_report_path: ${{ steps.cfg.outputs.jacoco_xml_report_path }}
      dockerImage:            ${{ steps.cfg.outputs.dockerImage }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Ls
        run: ls /.github/

      - name: Ensure config file exists
        run: |
          test -f "${{ inputs.config-path }}" || {
            echo "::error file=${{ inputs.config-path }}::Config file not found"
            exit 1
          }

      - name: Read CI properties
        id: read
        run: |
          echo "ci_json<<EOF" >> "$GITHUB_OUTPUT"
          cat "${{ inputs.config-path }}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Parse JSON â†’ step outputs (empty if missing)
        id: cfg
        run: |
          echo "maven_sbom_path=${{        fromJson(steps.read.outputs.ci_json).maven_sbom_path        || '' }}" >> "$GITHUB_OUTPUT"
          echo "maven_artifact_path=${{    fromJson(steps.read.outputs.ci_json).maven_artifact_path    || '' }}" >> "$GITHUB_OUTPUT"
          echo "maven_parameters=${{       fromJson(steps.read.outputs.ci_json).maven_parameters       || '' }}" >> "$GITHUB_OUTPUT"
          echo "npm_sbom_path=${{          fromJson(steps.read.outputs.ci_json).npm_sbom_path          || '' }}" >> "$GITHUB_OUTPUT"
          echo "npm_artifact_path=${{      fromJson(steps.read.outputs.ci_json).npm_artifact_path      || '' }}" >> "$GITHUB_OUTPUT"
          echo "jacoco_xml_report_path=${{ fromJson(steps.read.outputs.ci_json).jacoco_xml_report_path || '' }}" >> "$GITHUB_OUTPUT"
          echo "dockerImage=${{            fromJson(steps.read.outputs.ci_json).dockerImage            || '' }}" >> "$GITHUB_OUTPUT"
