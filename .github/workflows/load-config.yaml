name: Load CI config

on:
  workflow_call:
    inputs:
      config-path:
        description: "Path to JSON config in the caller repo"
        required: false
        type: string
        default: "./.github/ci-properties.json"
    outputs:
      maven_sbom_path:
        description: "Maven SBOM path"
        value: ${{ jobs.parse.outputs.maven_sbom_path }}
      maven_artifact_path:
        description: "Maven artifact path"
        value: ${{ jobs.parse.outputs.maven_artifact_path }}
      maven_parameters:
        description: "Extra Maven parameters"
        value: ${{ jobs.parse.outputs.maven_parameters }}
      npm_sbom_path:
        description: "NPM SBOM path"
        value: ${{ jobs.parse.outputs.npm_sbom_path }}
      npm_artifact_path:
        description: "NPM artifact path"
        value: ${{ jobs.parse.outputs.npm_artifact_path }}
      jacoco_xml_report_path:
        description: "JaCoCo XML report path"
        value: ${{ jobs.parse.outputs.jacoco_xml_report_path }}
      dockerImage:
        description: "Docker image for testing and deployment"
        value: ${{ jobs.parse.outputs.dockerImage }}

jobs:
  parse:
    runs-on: ubuntu-latest
    outputs:
      maven_sbom_path:        ${{ steps.cfg.outputs.maven_sbom_path }}
      maven_artifact_path:    ${{ steps.cfg.outputs.maven_artifact_path }}
      maven_parameters:       ${{ steps.cfg.outputs.maven_parameters }}
      npm_sbom_path:          ${{ steps.cfg.outputs.npm_sbom_path }}
      npm_artifact_path:      ${{ steps.cfg.outputs.npm_artifact_path }}
      jacoco_xml_report_path: ${{ steps.cfg.outputs.jacoco_xml_report_path }}
      dockerImage:            ${{ steps.cfg.outputs.dockerImage }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Ensure config file exists
        run: |
          test -f "${{ inputs.config-path }}" || {
            echo "::error file=${{ inputs.config-path }}::Config file not found"
            exit 1
          }

      - name: Parse ci-properties.json â†’ step outputs (empty if key missing)
        id: cfg
        run: |
          FILE="${{ inputs.config-path }}"
          echo "maven_sbom_path=$(jq -r '.maven_sbom_path // ""' "$FILE")"               >> "$GITHUB_OUTPUT"
          echo "maven_artifact_path=$(jq -r '.maven_artifact_path // ""' "$FILE")"       >> "$GITHUB_OUTPUT"
          echo "maven_parameters=$(jq -r '.maven_parameters // ""' "$FILE")"             >> "$GITHUB_OUTPUT"
          echo "npm_sbom_path=$(jq -r '.npm_sbom_path // ""' "$FILE")"                   >> "$GITHUB_OUTPUT"
          echo "npm_artifact_path=$(jq -r '.npm_artifact_path // ""' "$FILE")"           >> "$GITHUB_OUTPUT"
          echo "jacoco_xml_report_path=$(jq -r '.jacoco_xml_report_path // ""' "$FILE")" >> "$GITHUB_OUTPUT"
          echo "dockerImage=$(jq -r '.dockerImage // ""' "$FILE")"                       >> "$GITHUB_OUTPUT"
