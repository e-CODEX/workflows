name: "Maven CI pipeline"
on:
  workflow_call:
    inputs:
      java-version:
        description: "Java version to use for the build. (Tests are run on the latest LTS version)"
        required: true
        default: 21
        type: number
      maven-parameters:
        description: "Extra parameters to pass to Maven"
        required: false
        type: string  
        default: ""
      sbom-path:
        description: "Path to the SBOM file generated by the build"
        required: true
        type: string
permissions:
  contents: read

jobs:        
  test:
    name: Test on ${{ matrix.os }} and JDK ${{ matrix.java-version }}
    permissions:
      contents: write 
      pull-requests: write # required for updating PR comments
    strategy:
      matrix:
        os: [windows-latest, macos-14, ubuntu-latest] # Macos 13 is x86-64 and 14 is aarch64
        java-version: [21]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Graphviz
        uses: e-CODEX/workflows/.github/actions/install-graphviz@main

      - name: Setup Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}
          cache: gradle

      - name: Make Gradle wrapper executable
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      - name: Run tests with Gradle
        run: ./gradlew test ${{ inputs.gradle-parameters }}

  build:
    name: Build artifact and SBOM using Java ${{ inputs.java-version }}
    permissions:
      contents: write
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java-version }}

      - name: Make Gradle wrapper executable
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      - name: Build with Maven
        run: |
          ./gradlew clean build ${{ inputs.gradle-parameters }}

      - name: Upload SBOM to GitHub as an artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom
          path: ${{ inputs.sbom-path }}
